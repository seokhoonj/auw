% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/relative-risk.R
\name{subset_cohort_by_id_with_kcd}
\alias{subset_cohort_by_id_with_kcd}
\title{Subset a cohort \strong{by IDs} flagged for KCD within an underwriting window}
\usage{
subset_cohort_by_id_with_kcd(
  cohort,
  id_var,
  kcd_var,
  from_var,
  to_var,
  uw_date,
  start,
  end,
  ...
)
}
\arguments{
\item{cohort}{A cohort data frame at \strong{episode level} (multiple rows per ID).}

\item{id_var}{Column used as the ID; unquoted column name (e.g., \code{id}).}

\item{kcd_var}{Column containing KCD codes; unquoted column name (e.g., \code{kcd}).}

\item{from_var}{Column with row start dates; unquoted (e.g., \code{sdate}). Must be \code{Date}.}

\item{to_var}{Column with row end dates; unquoted (e.g., \code{edate}). Must be \code{Date}.}

\item{uw_date}{Underwriting reference date of type \code{Date}.}

\item{start}{Months \strong{before} \code{uw_date} to start the window (negative numeric).}

\item{end}{Months \strong{after} \code{uw_date} to end the window (positive numeric).}

\item{...}{One or more KCD patterns as character scalars. Each element can be
a plain string or a PCRE (perl) regex. Prefix with \code{"!"} to exclude IDs
matching that pattern (e.g., \code{"!M51|S33"}).}
}
\value{
A cohort subset of the \strong{same class} as \code{cohort} (data.frame / tibble / data.table),
containing \strong{all rows} for IDs that satisfied the KCD-in-window condition (after
applying any exclusions).
}
\description{
Given a cohort data frame with ID, KCD, and service date range columns,
this function:
\enumerate{
\item Computes a date window \verb{[uw_date + start months, uw_date + end months]}
for each record. These boundary dates are stored internally as:
\itemize{
\item \code{fdate}: the window \strong{start date} (underwriting date + start months)
\item \code{tdate}: the window \strong{end date} (underwriting date + end months).
}
\item Finds IDs whose any row has \code{to_var >= fdate} and \code{from_var < tdate}
\strong{and} whose \code{kcd_var} matches one or more KCD patterns.
\item Returns the \strong{entire} cohort subset for those IDs.
}
}
\details{
Select \strong{all rows for IDs} who had at least one record with specified
KCD code(s) during a window around an underwriting date. The window is
defined in \strong{months} relative to \code{uw_date} (negative = before, positive = after).
Matching is performed on the KCD column, but the \strong{result includes every row
of those IDs} (i.e., not only the matching KCD rows).

Internally converts to data.table for speed via \code{instead::ensure_dt_env()},
computes the inclusion/exclusion ID set using \code{grepl(perl = TRUE)},
and restores the original input class on return.
}
\section{Selection semantics}{

\itemize{
\item Date overlap uses half-open interval: \verb{[from, to]} via
\code{to_var >= fdate & from_var < tdate}.
\item KCD matching uses \code{grepl(..., perl = TRUE)}; supply regular expressions if needed.
\item You may prefix a pattern with \code{"!"} to \strong{exclude} IDs matching that pattern
(applied after any prior inclusions). You can pass multiple patterns via \code{...}.
}
}

\examples{
\dontrun{
# Include IDs with any M51 within [-60, +36] months of uw_date, then keep ALL their rows
subset_cohort_by_id_with_kcd(
  cohort, id, kcd, sdate, edate,
  uw_date = as.Date("2018-07-01"),
  start = -60, end = 36,
  "M51"
)

# Include M79 or S33, then exclude any ^C codes by regex
subset_cohort_by_id_with_kcd(
  cohort, id, kcd, sdate, edate,
  uw_date = as.Date("2018-07-01"),
  start = -24, end = 12,
  "M79|S33", "!^C"
)
}

}
\seealso{
\code{\link[=summarise_id_with_kcd]{summarise_id_with_kcd()}} to get the \strong{distinct ID list} without expanding to full rows.
}
