% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/relative-risk.R
\name{summarise_id_with_kcd}
\alias{summarise_id_with_kcd}
\title{Summarise IDs with KCD terms}
\usage{
summarise_id_with_kcd(
  cohort,
  id_var,
  group_var,
  kcd_var,
  from_var,
  to_var,
  uw_date,
  ...
)
}
\arguments{
\item{cohort}{A cohort data frame at \strong{episode level} (multiple rows per ID).}

\item{id_var}{Column with ID; unquoted (e.g., \code{id}) or character (e.g., \code{"id"}).}

\item{group_var}{Optional grouping column(s) (e.g., age band, gender);
unquoted or character. Use \code{NULL} if none.}

\item{kcd_var}{Column with KCD codes; unquoted or character.}

\item{from_var}{Start date column of each episode; unquoted or character.}

\item{to_var}{End date column of each episode; unquoted or character.}

\item{uw_date}{Underwriting date used as time zero; a scalar date-like
(\code{"YYYY-MM-DD"}, \code{Date}, or \code{POSIXt}).}

\item{...}{One or more KCD term windows, each as
\code{list(start_months, end_months, pattern)} where \code{start_months} is
months \strong{before} \code{uw_date} (negative), \code{end_months} is months
\strong{after} \code{uw_date} (positive), and \code{pattern} is a KCD code or regex
(e.g., \code{"E1[0-4]"}). Optionally give each list a name to control
the output column name.}
}
\value{
An object of the same base class as \code{cohort} with prepended class
\code{"ir.data"}. Contains one row per ID(+group) and 0/1 KCD flag columns.
}
\description{
Starting from an \emph{episode-level} cohort (multiple rows per ID with
\verb{[from,to]} and \code{kcd}), produce an \strong{ID-level summary table} with
0/1 flag columns for each specified KCD window relative to \code{uw_date}.
Internally converts to data.table (via \code{\link[=ensure_dt_env]{ensure_dt_env()}}) for
efficiency, then restores the result and attached summaries to the
original class of \code{cohort} (data.frame / tibble / data.table).
}
\details{
\itemize{
\item Produces one row per ID(+group), with a 0/1 flag column for each KCD term.
\item Named \code{...} arguments become the column names; unnamed terms default to
\code{"pattern_start_end"}.
\item Also attaches summary tables as attributes:
\itemize{
\item \code{attr(x, "raw")}: lowest-level contingency table
\item \code{attr(x, "summary")}: first-level summary (alias of \code{"summary.1"})
\item \code{attr(x, "summary.N")}: deeper summaries by nested groupings
}
\item The main result is restored to the original class of \code{cohort} and prepended
with S3 class \code{"ir.data"}.
}
}
\examples{
\dontrun{
# Example with unquoted columns
res <- summarise_id_with_kcd(
  cohort    = cohort,
  id_var    = id,
  group_var = age_band,
  kcd_var   = kcd,
  from_var  = sdate,
  to_var    = edate,
  uw_date     = "2017-08-01",
  hypertension = list(-60, 0,  "I10"),
  cv_event     = list(  0, 36, "I2[0-5]|I6[0-9]|G46")
)
head(res)

# Example with character column names
res2 <- summarise_id_with_kcd(
  cohort    = cohort,
  id_var    = "id",
  group_var = "age_band",
  kcd_var   = "kcd",
  from_var  = "sdate",
  to_var    = "edate",
  uw_date     = "2017-08-01",
  list(-60, 0, "I10")
)
}

}
\seealso{
\code{\link[=subset_cohort_by_id_with_kcd]{subset_cohort_by_id_with_kcd()}}, \code{\link[instead:ensure_dt_env]{instead::ensure_dt_env()}}, \code{\link[instead:capture_names]{instead::capture_names()}}
}
