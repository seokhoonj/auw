% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/relative-risk.R
\name{summarise_id_with_kcd_ir}
\alias{summarise_id_with_kcd_ir}
\title{Summarise IDs by KCD terms to support "Incidence Rate" calculation (class-preserving)}
\usage{
summarise_id_with_kcd_ir(
  cohort,
  id_var,
  group_var,
  kcd_var,
  from_var,
  to_var,
  uw_date,
  decl1 = NULL,
  decl2 = NULL,
  decl3 = NULL,
  excl = NULL,
  claim = NULL
)
}
\arguments{
\item{cohort}{A cohort data frame at \strong{episode level} (multiple rows per ID).}

\item{id_var}{ID column; unquoted (e.g., \code{id}) or character (e.g., \code{"id"}).}

\item{group_var}{Optional grouping column (e.g., age band, gender);
unquoted or character. Use \code{NULL} for no grouping.}

\item{kcd_var}{Column with KCD codes; unquoted or character.}

\item{from_var}{Start date column of each episode; unquoted or character.}

\item{to_var}{End date column of each episode; unquoted or character.}

\item{uw_date}{Underwriting date used as time zero; character \code{"YYYY-MM-DD"},
\code{Date}, or \code{POSIXt}.}

\item{decl1, decl2, decl3}{Optional declaration windows as lists of the form
\code{list(start_months, end_months, pattern)} where \code{start_months} is months
\strong{before} \code{uw_date} (negative), \code{end_months} is months \strong{after} \code{uw_date}
(positive), and \code{pattern} is a KCD code or regex (e.g., \code{"E1[0-4]"}).}

\item{excl}{Optional exclusion window, same list form.}

\item{claim}{Optional claim window, same list form.}
}
\value{
An object of the same base class as \code{df}, with prepended class \code{"ir.data"}.
One row per ID(+group) and 0/1 KCD flag columns. A restored summary is available
at \code{attr(result, "summary")} (class-prepended \code{"ir"}).
}
\description{
From an episode-level cohort (multiple rows per ID with \verb{[from, to]} and \code{kcd}),
produce an \strong{ID-level summary table} with 0/1 flags for each specified KCD
window around \code{uw_date}. Internally converts to data.table (via
\code{\link[instead:ensure_dt_env]{instead::ensure_dt_env()}}) for speed, then restores both the main result and the
summaries to the original base class of \code{df} (data.frame / tibble / data.table).
The main result prepends S3 class \code{"ir.data"}, the summary prepends \code{"ir"}.
}
\details{
\itemize{
\item Column arguments accept both unquoted and character inputs; they are
normalised with \code{instead::capture_names()} against the working \code{data.table}.
\item Flags and summaries are computed by \code{summarise_id_with_kcd_terms()} and then
post-processed: multiple \verb{decl*} columns can be collapsed into a single
\code{"decl"} factor for compactness.
\item Attributes attached:
\itemize{
\item \code{attr(x, "summary")}: first-level summary (restored, class-prepended \code{"ir"}).
\item \code{attr(x, "summary.N")}: deeper summaries, if present (restored).
\item \code{attr(x, "raw")}: contingency table at the lowest level, if present (restored).
\item On the summary: \code{"decl"}, \code{"excl"}, \code{"claim"} strings if provided.
}
}
}
\examples{
\dontrun{
res <- summarise_id_with_kcd_ir(
  cohort    = cohort,
  id_var    = id,
  group_var = age_band,
  kcd_var   = kcd,
  from_var  = sdate,
  to_var    = edate,
  uw_date     = "2018-07-01",
  decl1     = list(-60, 0,  "I10"),
  decl2     = list(-60, 0,  "E78"),
  excl      = list(-60, 0,  "I2[0-5]|I6[0-9]|G46"),
  claim     = list(  0, 36, "I2[0-5]|I6[0-9]|G46")
)
class(res)          # includes "ir.data"
class(summary(res)) # includes "ir"
}

}
\seealso{
\code{\link[=summarise_id_with_kcd]{summarise_id_with_kcd()}}, \code{\link[instead:ensure_dt_env]{instead::ensure_dt_env()}}, \code{\link[instead:capture_names]{instead::capture_names()}}
}
